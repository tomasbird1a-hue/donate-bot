<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MagicRP Shop</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg: #09090b; --card: #18181b; --primary: #6366f1; --green: #22c55e; --text: #fff; --sub: #a1a1aa;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: var(--text); padding: 16px; padding-bottom: 80px; }
        
        /* –¢–∞–±—ã */
        .tab-bar { position: fixed; bottom: 0; left: 0; width: 100%; background: rgba(9,9,11,0.95); border-top: 1px solid #333; padding: 10px; display: flex; justify-content: space-around; backdrop-filter: blur(10px); z-index: 99; }
        .tab-btn { background: none; border: none; font-size: 24px; opacity: 0.5; transition: 0.2s; }
        .tab-btn.active { opacity: 1; transform: scale(1.1); color: var(--primary); }

        /* –°—Ç—Ä–∞–Ω–∏—Ü—ã */
        .page { display: none; animation: fade 0.3s; }
        .page.active { display: block; }
        @keyframes fade { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* –ö–∞—Ä—Ç–æ—á–∫–∏ */
        .card { background: var(--card); border: 1px solid #333; border-radius: 16px; padding: 16px; margin-bottom: 12px; }
        .btn { width: 100%; padding: 12px; background: var(--primary); color: #fff; border: none; border-radius: 10px; font-weight: 600; margin-top: 10px; cursor: pointer; }
        .btn:active { transform: scale(0.98); opacity: 0.8; }
        .btn-green { background: var(--green); }
        .btn-outline { background: transparent; border: 1px solid #333; color: var(--sub); }

        /* –°—Ç–∞—Ç—É—Å—ã */
        .status-wait { color: #f59e0b; background: rgba(245, 158, 11, 0.1); padding: 4px 8px; border-radius: 6px; font-size: 12px; }
        .status-done { color: var(--green); background: rgba(34, 197, 94, 0.1); padding: 4px 8px; border-radius: 6px; font-size: 12px; }

        /* –ê–¥–º–∏–Ω–∫–∞ */
        .admin-box { border: 1px dashed #444; padding: 15px; border-radius: 12px; margin-top: 20px; background: rgba(0,0,0,0.2); }
        .input-group { margin-bottom: 10px; }
        .input-group label { display: block; font-size: 12px; color: var(--sub); margin-bottom: 5px; }
        .input-field { width: 100%; background: #000; border: 1px solid #333; color: #fff; padding: 10px; border-radius: 8px; outline: none; }
    </style>
</head>
<body>

    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="font-weight: 800; background: linear-gradient(45deg, #6366f1, #a855f7); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">MagicRP</h2>
        <div style="background: rgba(255,255,255,0.1); padding: 5px 12px; border-radius: 20px; font-weight: 600;">
            <span id="balance">0</span> ‚ÇΩ
        </div>
    </div>

    <div id="shop" class="page active">
        <div class="card">
            <div style="display:flex; justify-content:space-between;">
                <b>VIP Status</b>
                <span style="color:var(--green)">150 ‚ÇΩ</span>
            </div>
            <div style="font-size:13px; color:var(--sub); margin:5px 0;">x2 –û–ø—ã—Ç, –ü—Ä–µ—Ñ–∏–∫—Å, –°–∫–∏–Ω—ã</div>
            <button class="btn" onclick="buyItem('VIP Status', 150)">–ö—É–ø–∏—Ç—å</button>
        </div>

        <div class="card">
            <div style="display:flex; justify-content:space-between;">
                <b>1.000.000 $</b>
                <span style="color:var(--green)">100 ‚ÇΩ</span>
            </div>
            <div style="font-size:13px; color:var(--sub); margin:5px 0;">–ò–≥—Ä–æ–≤–∞—è –≤–∞–ª—é—Ç–∞</div>
            <button class="btn" onclick="buyItem('1KK Virt', 100)">–ö—É–ø–∏—Ç—å</button>
        </div>
        
        <div class="card">
            <div style="display:flex; justify-content:space-between;">
                <b>–†–∞–∑–±–∞–Ω</b>
                <span style="color:var(--green)">300 ‚ÇΩ</span>
            </div>
            <div style="font-size:13px; color:var(--sub); margin:5px 0;">–ü–æ–ª–Ω–æ–µ —Å–Ω—è—Ç–∏–µ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫</div>
            <button class="btn" onclick="buyItem('Unban', 300)">–ö—É–ø–∏—Ç—å</button>
        </div>
    </div>

    <div id="orders" class="page">
        <h3 style="margin-bottom:15px;">–ú–æ–∏ –ø–æ–∫—É–ø–∫–∏</h3>
        <div id="my-orders-list">
            <div style="text-align:center; color:var(--sub); padding:20px;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>
        
        <div class="card" style="margin-top:20px; text-align:center;">
            <p style="font-size:14px; margin-bottom:10px;">–í–æ–∑–Ω–∏–∫–ª–∏ –≤–æ–ø—Ä–æ—Å—ã?</p>
            <button class="btn btn-outline" onclick="contactManager()">üí¨ –ù–∞–ø–∏—Å–∞—Ç—å –ú–µ–Ω–µ–¥–∂–µ—Ä—É</button>
        </div>
    </div>

    <div id="profile" class="page">
        <div class="card" style="text-align:center;">
            <div style="width:60px; height:60px; background:var(--primary); border-radius:50%; margin:0 auto 10px; display:flex; align-items:center; justify-content:center; font-size:24px;">üë§</div>
            <h3 id="username">User</h3>
            <p style="color:var(--sub); font-size:12px;">ID: <span id="userid">000</span></p>
        </div>

        <div id="admin-panel" style="display:none;">
            <div class="admin-box">
                <h4 style="margin-bottom:10px; color:#f59e0b;">‚ö° –ê–¥–º–∏–Ω: –í—ã–¥–∞—á–∞ –¥–µ–Ω–µ–≥</h4>
                <div class="input-group">
                    <label>ID –ò–≥—Ä–æ–∫–∞</label>
                    <input type="number" id="adm-target-id" class="input-field" placeholder="123456789">
                </div>
                <div class="input-group">
                    <label>–°—É–º–º–∞ (‚ÇΩ)</label>
                    <input type="number" id="adm-amount" class="input-field" placeholder="1000">
                </div>
                <button class="btn btn-green" onclick="adminTopUp()">–ü–æ–ø–æ–ª–Ω–∏—Ç—å</button>
            </div>

            <div class="admin-box">
                <h4 style="margin-bottom:10px; color:#f59e0b;">üìã –ó–∞–∫–∞–∑—ã –≤ –æ–∂–∏–¥–∞–Ω–∏–∏</h4>
                <div id="admin-orders-list">
                    <p style="color:var(--sub); font-size:12px;">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤</p>
                </div>
            </div>
        </div>
    </div>

    <div class="tab-bar">
        <button class="tab-btn active" onclick="switchTab('shop', this)">üè†</button>
        <button class="tab-btn" onclick="switchTab('orders', this)">üõí</button>
        <button class="tab-btn" onclick="switchTab('profile', this)">‚öôÔ∏è</button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        // 1. –ü–û–õ–£–ß–ï–ù–ò–ï –ò –†–ê–°–ü–ê–ö–û–í–ö–ê –î–ê–ù–ù–´–•
        // –î–∞–Ω–Ω—ã–µ –ø—Ä–∏—Ö–æ–¥—è—Ç –≤ URL –≤ –ø–∞—Ä–∞–º–µ—Ç—Ä–µ ?data={json}
        const urlParams = new URLSearchParams(window.location.search);
        let appData = { bal: 0, admin: false, manager: '', my_orders: [], admin_orders: [] };

        try {
            const rawData = urlParams.get('data');
            if (rawData) {
                appData = JSON.parse(decodeURIComponent(rawData));
            }
        } catch (e) { console.error('Error parsing data', e); }

        // 2. –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
        document.getElementById('balance').innerText = appData.bal;
        document.getElementById('username').innerText = tg.initDataUnsafe?.user?.first_name || 'Guest';
        document.getElementById('userid').innerText = tg.initDataUnsafe?.user?.id || '000';

        // –†–µ–Ω–¥–µ—Ä –º–æ–∏—Ö –∑–∞–∫–∞–∑–æ–≤
        const myOrdersContainer = document.getElementById('my-orders-list');
        if (appData.my_orders.length === 0) {
            myOrdersContainer.innerHTML = '<div style="color:var(--sub); text-align:center;">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</div>';
        } else {
            myOrdersContainer.innerHTML = '';
            appData.my_orders.forEach(order => {
                const statusHtml = order.status === 'wait' 
                    ? '<span class="status-wait">–û–∂–∏–¥–∞–µ—Ç</span>' 
                    : '<span class="status-done">–í—ã–¥–∞–Ω–æ</span>';
                
                myOrdersContainer.innerHTML += `
                    <div class="card" style="padding:12px;">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <b>${order.item}</b>
                            ${statusHtml}
                        </div>
                        <div style="font-size:12px; color:var(--sub); margin-top:4px;">–¶–µ–Ω–∞: ${order.price} ‚ÇΩ</div>
                    </div>
                `;
            });
        }

        // –†–µ–Ω–¥–µ—Ä –ê–¥–º–∏–Ω–∫–∏
        if (appData.admin) {
            document.getElementById('admin-panel').style.display = 'block';
            
            const adminOrdersContainer = document.getElementById('admin-orders-list');
            if (appData.admin_orders.length > 0) {
                adminOrdersContainer.innerHTML = '';
                appData.admin_orders.forEach(ord => {
                    adminOrdersContainer.innerHTML += `
                        <div class="card" style="background:#000; padding:10px; margin-bottom:8px;">
                            <div style="font-size:13px;"><b>${ord.item}</b> –∑–∞ ${ord.price}‚ÇΩ</div>
                            <div style="font-size:11px; color:var(--sub);">–ò–≥—Ä–æ–∫: ${ord.user} (ID: ${ord.uid})</div>
                            <button class="btn btn-green" style="padding:8px; font-size:12px; margin-top:8px;" 
                                onclick="adminComplete(${ord.id}, ${ord.uid})">‚úÖ –í–´–î–ê–¢–¨</button>
                        </div>
                    `;
                });
            }
        }

        // --- –§–£–ù–ö–¶–ò–ò ---

        function switchTab(id, btn) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }

        function buyItem(name, price) {
            if (appData.bal < price) {
                tg.showAlert('‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤!');
                return;
            }
            tg.showConfirm(`–ö—É–ø–∏—Ç—å ${name} –∑–∞ ${price} ‚ÇΩ?`, (ok) => {
                if (ok) {
                    tg.sendData(JSON.stringify({ action: 'buy', item: name, price: price }));
                }
            });
        }

        function contactManager() {
            if (appData.manager) {
                tg.openTelegramLink('https://t.me/' + appData.manager);
            } else {
                tg.showAlert('–ö–æ–Ω—Ç–∞–∫—Ç—ã –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã');
            }
        }

        // --- –§–£–ù–ö–¶–ò–ò –ê–î–ú–ò–ù–ê ---
        function adminTopUp() {
            const id = document.getElementById('adm-target-id').value;
            const amount = document.getElementById('adm-amount').value;
            if (!id || !amount) return tg.showAlert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');

            tg.showConfirm(`–í—ã–¥–∞—Ç—å ${amount}‚ÇΩ –∏–≥—Ä–æ–∫—É ${id}?`, (ok) => {
                if (ok) {
                    tg.sendData(JSON.stringify({ 
                        action: 'admin_topup', 
                        target_id: id, 
                        amount: amount 
                    }));
                }
            });
        }

        function adminComplete(orderId, userId) {
            tg.showConfirm('–û—Ç–º–µ—Ç–∏—Ç—å –∑–∞–∫–∞–∑ –∫–∞–∫ –≤—ã–¥–∞–Ω–Ω—ã–π?', (ok) => {
                if (ok) {
                    tg.sendData(JSON.stringify({
                        action: 'admin_complete',
                        order_id: orderId,
                        target_id: userId
                    }));
                }
            });
        }
    </script>
</body>
</html>
