<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MagicRP Store</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg: #0f1115; --card: #181b21; --primary: #5865F2; --text: #fff; --sub: #9ca3af; --green: #22c55e;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, sans-serif; }
        body { background: var(--bg); color: var(--text); padding: 16px; min-height: 100vh; }
        
        /* Табы */
        .tabs { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 20px; background: var(--card); padding: 4px; border-radius: 12px; }
        .tab { padding: 10px; border: none; background: none; color: var(--sub); font-weight: 600; cursor: pointer; border-radius: 8px; transition: 0.2s; }
        .tab.active { background: var(--primary); color: #fff; }

        /* Контент */
        .page { display: none; animation: fade 0.3s; }
        .page.active { display: block; }
        @keyframes fade { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Товар */
        .item { background: var(--card); border: 1px solid rgba(255,255,255,0.05); border-radius: 16px; padding: 16px; margin-bottom: 12px; }
        .item-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .price { background: rgba(34, 197, 94, 0.1); color: var(--green); padding: 4px 8px; border-radius: 6px; font-weight: 700; font-size: 14px; }
        .btn { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; margin-top: 10px; }
        .btn:active { transform: scale(0.98); }

        /* Профиль */
        .profile { background: linear-gradient(145deg, #1e232b, #181b21); border-radius: 16px; padding: 20px; text-align: center; border: 1px solid rgba(255,255,255,0.05); }
        .avatar { width: 64px; height: 64px; background: var(--primary); border-radius: 50%; margin: 0 auto 12px; display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: bold; }
        .stats { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .stat-box { background: rgba(255,255,255,0.03); padding: 10px; border-radius: 8px; }
        .val { font-size: 18px; font-weight: 700; display: block; }
        .lbl { font-size: 11px; color: var(--sub); text-transform: uppercase; }

        /* Админка */
        .admin-panel { margin-top: 20px; padding-top: 20px; border-top: 1px dashed var(--sub); display: none; }
        .admin-tag { background: #f59e0b; color: #000; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 800; vertical-align: middle; }
    </style>
</head>
<body>

    <div class="tabs">
        <button class="tab active" onclick="setTab('shop')">Магазин</button>
        <button class="tab" onclick="setTab('profile')">Профиль</button>
    </div>

    <div id="shop" class="page active">
        <div class="item">
            <div class="item-head"><b>VIP Status</b> <span class="price">150 ₽</span></div>
            <div style="font-size: 13px; color: var(--sub);">x2 Опыт, Доступ к VIP чату, Префикс [VIP]</div>
            <button class="btn" onclick="buy('vip', 150, 'VIP Status')">Купить</button>
        </div>
        
        <div class="item">
            <div class="item-head"><b>Admin Level 1</b> <span class="price">500 ₽</span></div>
            <div style="font-size: 13px; color: var(--sub);">Базовые права, Кик, Мут, Джаил</div>
            <button class="btn" onclick="buy('admin1', 500, 'Admin Level 1')">Купить</button>
        </div>

        <div class="item">
            <div class="item-head"><b>Разбан</b> <span class="price">200 ₽</span></div>
            <div style="font-size: 13px; color: var(--sub);">Полное снятие всех блокировок</div>
            <button class="btn" onclick="buy('unban', 200, 'Разбан')">Купить</button>
        </div>
    </div>

    <div id="profile" class="page">
        <div class="profile-card">
            <div class="avatar" id="ava">?</div>
            <h3 id="username">Загрузка...</h3>
            <div style="font-size: 12px; color: var(--sub); margin-bottom: 15px;" id="userid">ID: 000000</div>
            
            <div class="stats">
                <div class="stat-box">
                    <span class="val" id="balance">0 ₽</span>
                    <span class="lbl">Баланс</span>
                </div>
                <div class="stat-box">
                    <span class="val" id="role">Игрок</span>
                    <span class="lbl">Статус</span>
                </div>
            </div>

            <div id="admin-area" class="admin-panel">
                <h4 style="margin-bottom: 10px;">Панель <span class="admin-tag">ADMIN</span></h4>
                <div style="font-size: 13px; color: var(--sub); margin-bottom: 10px;">
                    Статистика сервера: <br>
                    Всего юзеров: <span id="total-users">0</span>
                </div>
                <button class="btn" style="background: #333;" onclick="tg.close()">Закрыть панель</button>
            </div>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        // Получаем параметры из ссылки (которую сгенерировал бот)
        const params = new URLSearchParams(window.location.search);
        const userBalance = parseInt(params.get('bal') || '0');
        const isAdmin = params.get('admin') === '1';
        const totalUsers = params.get('users') || '1';
        
        // Данные из Телеграма
        const user = tg.initDataUnsafe?.user || { first_name: 'GUEST', id: 0 };

        // Инициализация
        document.getElementById('username').innerText = user.first_name;
        document.getElementById('ava').innerText = user.first_name[0];
        document.getElementById('userid').innerText = `ID: ${user.id}`;
        document.getElementById('balance').innerText = `${userBalance} ₽`;
        
        if (isAdmin) {
            document.getElementById('role').innerText = "Основатель";
            document.getElementById('role').style.color = "#f59e0b";
            document.getElementById('admin-area').style.display = "block";
            document.getElementById('total-users').innerText = totalUsers;
        }

        function setTab(name) {
            document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
            document.getElementById(name).classList.add('active');
            event.target.classList.add('active');
        }

        function buy(code, price, name) {
            if (userBalance < price) {
                tg.showAlert(`❌ Недостаточно средств! Нужно: ${price} ₽`);
                return;
            }

            tg.showConfirm(`Купить "${name}" за ${price} ₽?`, (ok) => {
                if (ok) {
                    // Отправляем данные боту. Бот сам спишет деньги.
                    const data = JSON.stringify({
                        action: 'buy',
                        item_code: code,
                        item_name: name,
                        price: price
                    });
                    tg.sendData(data);
                }
            });
        }
    </script>
</body>
</html>
